#!/usr/bin/env python3

import os
import os.path as osp
import subprocess

HOME = "/home/gb"
REPO = osp.join(HOME, "dots")
LIST = osp.join(REPO, "managed.txt")


def sync(managed, src, dst):
    # files to synchronize with the relative path
    files = []
    with open(managed, "rt") as fp:
        for line in fp:
            name = line.strip()
            if not name or name.startswith("#"):
                continue
            files.append(name)

    for file in files:
        spath = osp.join(src, file)
        dpath = osp.join(dst, file)
        if not osp.exists(spath):
            if osp.isfile(dpath):
                print(f"remove {dpath}")
                # os.remove(dpath)
            elif osp.isdir(dpath):
                print("not removing folder", dpath)
        print(f"rsync -a --delete {spath} {dpath}")
        # subprocess.run(["rsync", "-a", "--delete", spath, dpath])


# copy the files from HOME into the REPO
sync(LIST, HOME, REPO)

# fetch files from the remote
subprocess.run(["git", "fetch"], cwd=REPO)

# run nvim so I can manage the merge
subprocess.run(["nvim", "-c", "G", "-c", "only"], cwd=REPO)

# copy the files back out
sync(LIST, REPO, HOME)
